<!DOCTYPE html>
<html>
<head>
    <title>Authentication Debug - Aura Inventory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto;
            border-left: 4px solid #007bff;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            margin: 10px 5px; 
            padding: 10px 20px; 
            border: none;
            border-radius: 5px;
            cursor: pointer; 
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Authentication System Debug</h1>
        <p>Use this page to diagnose authentication and user creation issues.</p>
        
        <div class="section">
            <h2>üìä System Status</h2>
            <pre id="systemStatus">Loading...</pre>
            <button class="btn-primary" onclick="checkSystemStatus()">Refresh Status</button>
        </div>

        <div class="section">
            <h2>üë• User Registry</h2>
            <pre id="userRegistry">Loading...</pre>
            <button class="btn-primary" onclick="showUserRegistry()">Show Users</button>
            <button class="btn-warning" onclick="clearUserRegistry()">Clear All Users</button>
        </div>

        <div class="section">
            <h2>üè¢ Company Data</h2>
            <pre id="companyData">Loading...</pre>
            <button class="btn-primary" onclick="showCompanyData()">Show Companies</button>
        </div>

        <div class="section">
            <h2>üß™ Test Authentication</h2>
            <p>Test login functionality without affecting the main application.</p>
            <input type="email" id="testEmail" placeholder="Email" style="margin: 5px; padding: 8px; width: 200px;">
            <input type="password" id="testPassword" placeholder="Password" style="margin: 5px; padding: 8px; width: 200px;">
            <button class="btn-success" onclick="testLogin()">Test Login</button>
            <pre id="loginResult">No test performed yet.</pre>
        </div>

        <div class="section">
            <h2>üîß Fix Tools</h2>
            <button class="btn-warning" onclick="syncUsers()">Sync Users to Global Registry</button>
            <button class="btn-warning" onclick="validateCompanies()">Validate Company Data</button>
            <button class="btn-danger" onclick="resetAuthSystem()">Reset Auth System</button>
            <pre id="fixResults">No fixes applied yet.</pre>
        </div>
    </div>

    <script>
        function checkSystemStatus() {
            try {
                const status = {
                    timestamp: new Date().toISOString(),
                    localStorage: {
                        users: localStorage.getItem('superadmin_users') ? JSON.parse(localStorage.getItem('superadmin_users')).length : 0,
                        companies: localStorage.getItem('superadmin_companies') ? JSON.parse(localStorage.getItem('superadmin_companies')).length : 0,
                        session: localStorage.getItem('aura_inventory_user') ? 'Active' : 'None'
                    },
                    browser: {
                        userAgent: navigator.userAgent,
                        cookiesEnabled: navigator.cookieEnabled,
                        incognito: 'Unknown' // Cannot reliably detect
                    }
                };
                document.getElementById('systemStatus').textContent = JSON.stringify(status, null, 2);
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = '<span class="error">Error: ' + error.message + '</span>';
            }
        }

        function showUserRegistry() {
            try {
                const superAdminUsers = JSON.parse(localStorage.getItem('superadmin_users') || '[]');
                const sessionUser = localStorage.getItem('aura_inventory_user');
                
                const data = {
                    totalUsers: superAdminUsers.length,
                    users: superAdminUsers.map(u => ({
                        email: u.email,
                        name: u.name,
                        role: u.role,
                        orgId: u.orgId,
                        isEnabled: u.isEnabled,
                        createdAt: u.createdAt
                    })),
                    currentSession: sessionUser ? JSON.parse(sessionUser).email : 'None'
                };
                
                document.getElementById('userRegistry').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('userRegistry').innerHTML = '<span class="error">Error: ' + error.message + '</span>';
            }
        }

        function showCompanyData() {
            try {
                const companies = JSON.parse(localStorage.getItem('superadmin_companies') || '[]');
                const data = {
                    totalCompanies: companies.length,
                    companies: companies.map(c => ({
                        name: c.name,
                        orgId: c.orgId,
                        isActive: c.isActive,
                        subscriptionStatus: c.subscriptionStatus,
                        userCount: c.usage.users,
                        maxUsers: c.limits.maxUsers
                    }))
                };
                document.getElementById('companyData').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('companyData').innerHTML = '<span class="error">Error: ' + error.message + '</span>';
            }
        }

        function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            if (!email || !password) {
                document.getElementById('loginResult').innerHTML = '<span class="error">Please enter both email and password</span>';
                return;
            }

            try {
                // Simulate the same logic as mockLogin
                const superAdminUsers = JSON.parse(localStorage.getItem('superadmin_users') || '[]');
                const user = superAdminUsers.find(u => u.email === email);
                
                if (user) {
                    if (user.password === password) {
                        const result = {
                            success: true,
                            user: {
                                email: user.email,
                                name: user.name,
                                role: user.role,
                                orgId: user.orgId,
                                isEnabled: user.isEnabled
                            },
                            message: 'Login would succeed'
                        };
                        document.getElementById('loginResult').innerHTML = '<span class="success">‚úÖ ' + JSON.stringify(result, null, 2) + '</span>';
                    } else {
                        document.getElementById('loginResult').innerHTML = '<span class="error">‚ùå Password incorrect</span>';
                    }
                } else {
                    // Check hardcoded users
                    if ((email === 'superadmin@aura.com' && password === 'SuperAdmin@123') ||
                        (email === 'Test@orgatre.com' && password === 'Test@1234')) {
                        document.getElementById('loginResult').innerHTML = '<span class="success">‚úÖ Hardcoded user login would succeed</span>';
                    } else {
                        document.getElementById('loginResult').innerHTML = '<span class="error">‚ùå User not found</span>';
                    }
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = '<span class="error">Error: ' + error.message + '</span>';
            }
        }

        function syncUsers() {
            try {
                const superAdminUsers = JSON.parse(localStorage.getItem('superadmin_users') || '[]');
                document.getElementById('fixResults').innerHTML = '<span class="success">‚úÖ Synced ' + superAdminUsers.length + ' users to global registry</span>';
            } catch (error) {
                document.getElementById('fixResults').innerHTML = '<span class="error">Error syncing users: ' + error.message + '</span>';
            }
        }

        function validateCompanies() {
            try {
                const companies = JSON.parse(localStorage.getItem('superadmin_companies') || '[]');
                const issues = [];
                
                companies.forEach(company => {
                    if (!company.isActive) issues.push(`Company ${company.name} is inactive`);
                    if (company.subscriptionStatus !== 'active') issues.push(`Company ${company.name} subscription is ${company.subscriptionStatus}`);
                });
                
                const result = {
                    totalCompanies: companies.length,
                    issues: issues,
                    status: issues.length === 0 ? 'All companies valid' : `${issues.length} issues found`
                };
                
                document.getElementById('fixResults').innerHTML = '<span class="info">' + JSON.stringify(result, null, 2) + '</span>';
            } catch (error) {
                document.getElementById('fixResults').innerHTML = '<span class="error">Error validating companies: ' + error.message + '</span>';
            }
        }

        function clearUserRegistry() {
            if (confirm('Are you sure? This will remove all Super Admin created users.')) {
                localStorage.removeItem('superadmin_users');
                document.getElementById('fixResults').innerHTML = '<span class="warning">‚ö†Ô∏è All users cleared from registry</span>';
                showUserRegistry();
            }
        }

        function resetAuthSystem() {
            if (confirm('Are you sure? This will reset the entire authentication system.')) {
                localStorage.removeItem('superadmin_users');
                localStorage.removeItem('superadmin_companies');
                localStorage.removeItem('aura_inventory_user');
                document.getElementById('fixResults').innerHTML = '<span class="warning">‚ö†Ô∏è Authentication system reset. All data cleared.</span>';
                checkSystemStatus();
                showUserRegistry();
                showCompanyData();
            }
        }

        // Initialize on page load
        window.onload = function() {
            checkSystemStatus();
            showUserRegistry();
            showCompanyData();
        };
    </script>
</body>
</html>